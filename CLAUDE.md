# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Klarna Network API Demo - A Next.js application for testing Klarna Network APIs with mTLS authentication support. Provides an interactive interface for making API requests, viewing responses, and managing environment variables.

## Development Commands

```bash
# Start development server (runs on http://localhost:3000)
npm run dev

# Build for production
npm run build

# Start production server
npm start

# Lint code
npm run lint
```

## Environment Setup

1. Copy `.env.local.example` to `.env.local`
2. Configure required variables:
   - `acquiring_partner_api_key` - Klarna API key (format: `klarna_test_api_...` or `klarna_live_api_...`)
   - `KLARNA_BASE_URL` - API base URL (test: `https://api-global.test.klarna.com`)
   - `KLARNA_CERT_PATH` / `KLARNA_KEY_PATH` - mTLS certificate paths (relative to project root)
   - `KLARNA_SKIP_MTLS` - Set to `true` to bypass mTLS for testing
3. Place mTLS certificates in `certs/` directory (gitignored)

## Architecture Overview

### Request Flow
1. **Frontend** (React/Next.js) → User selects endpoint preset or custom request
2. **API Proxy** (`app/api/klarna-proxy/route.ts`) → Server-side proxy that:
   - Loads mTLS certificates from filesystem
   - Injects API key from environment (never exposed to browser)
   - Generates required Klarna headers (correlation ID, idempotency key, integration metadata)
   - Makes HTTPS request with mTLS to Klarna API
   - Returns sanitized response to frontend
3. **Response Display** → JSON viewer with variable extraction support

### Key Design Patterns

**Security by Design:**
- API keys never exposed to browser (proxied through Next.js API route)
- mTLS certificates loaded server-side only
- Sensitive files (`.env.local`, `certs/`) are gitignored

**mTLS Authentication:**
- Certificates loaded from filesystem in `app/api/klarna-proxy/route.ts`
- Uses Node.js native `https` module (not axios) for proper mTLS support
- Can be disabled with `KLARNA_SKIP_MTLS=true` for testing

**Endpoint Presets System:**
- Static presets defined in `lib/klarna-endpoints.ts`
- Organized by category (credentials, accounts, onboarding, payments, webhooks, settlements)
- Includes path parameters, body templates, and descriptions
- Supports variable substitution with `{variable_name}` syntax

**Environment Variable Management:**
- Variables stored in browser localStorage with source tracking
- Supports extraction from API responses (e.g., save credential_id from response)
- Variable substitution in request bodies and paths using `{variable_name}` format

### Component Structure

**Pages:**
- `app/page.tsx` - API Tester interface (main page)
- `app/account_structure/page.tsx` - Account structure visualization with network diagram
- `app/payment-button/page.tsx` - Payment button demo

**Core Components:**
- `components/ApiTester.tsx` - Main controller for API testing UI
- `components/RequestForm.tsx` - Request configuration (method, path, headers, body)
- `components/ResponsePanel.tsx` - Response display with JSON viewer
- `components/EnvironmentPanel.tsx` - Environment variable management
- `components/KlarnaNetworkDiagram.tsx` - Visual network structure using ReactFlow

**API Integration:**
- `lib/klarna-endpoints.ts` - Endpoint preset definitions (1300+ lines)
- `lib/types.ts` - TypeScript interfaces for requests, responses, and UI state

## Important Patterns

### Klarna API Headers (auto-generated by proxy)
- `Authorization: Basic {acquiring_partner_api_key}`
- `Partner-Correlation-Id` - UUID v4 for request tracking
- `Klarna-Idempotency-Key` - UUID v5 (for POST/PATCH/PUT only)
- `Klarna-Integration-Metadata` - JSON with integrator info

### Path Parameter Substitution
Endpoints with `{parameter_name}` or `:parameter_name` in path require values:
```
/v2/accounts/{account_id}/stores/{store_id}
```
UI extracts these and prompts for values, substitutes before sending request.

### KRN Format
Klarna Resource Names follow pattern:
```
krn:partner:global:account:test:uuid
krn:partner:global:account:payment-product:uuid
```

## Package Installation Rules

**CRITICAL:** Developed on Klarna machine but deployed externally. Always use public npm registry:

```bash
# ✅ CORRECT - Use public registry
npm install <package> --registry=https://registry.npmjs.org/

# ❌ WRONG - Will fail in production
npm install <package>
```

Set in `.npmrc`:
```
registry=https://registry.npmjs.org/
```

## Clarification Pattern

When requirements are ambiguous or multiple approaches exist, ask for clarification rather than making assumptions. This applies to:
- Technical decisions (architecture, library choices)
- Missing context (which files/features to modify)
- Trade-offs between approaches
- User intent with multiple interpretations

## Documentation Maintenance

**IMPORTANT:** When making significant changes to the codebase, update relevant documentation to keep it in sync. This ensures users and future developers can understand the system accurately.

### When to Update Documentation

Update documentation when you:
- **Add new pages/routes** - New files in `app/` directory that create user-accessible pages
- **Modify existing routes** - Change page functionality, URL structure, or navigation
- **Add major features** - New capabilities, UI components, or API integrations
- **Change architecture** - Modify request flow, data patterns, or system design
- **Update environment variables** - Add/remove/rename variables in `.env.local.example`
- **Add/remove dependencies** - New packages that affect usage or setup

### What to Update

**For new pages/routes:**
- Update README.md "Usage" section with new route and its purpose
- Update CLAUDE.md "Component Structure" > "Pages" section with new page path and description
- Create feature documentation in `docs/` if the page introduces significant new functionality

**For major features:**
- Update README.md "Features" section with bullet point for new capability
- Add implementation details to CLAUDE.md "Architecture Overview" if it involves new patterns
- Create detailed documentation in `docs/` folder (e.g., `docs/FEATURE_NAME.md`) for complex features
- Update relevant sections in existing docs if the feature extends existing functionality

**For functionality changes:**
- Update affected sections in README.md (Features, Usage, Troubleshooting)
- Update CLAUDE.md if architectural patterns or workflows change
- Update existing docs in `docs/` folder if they reference the changed functionality

**For environment/configuration changes:**
- Update `.env.local.example` with new variables and comments
- Update README.md "Environment Setup" section
- Update CLAUDE.md "Environment Setup" section

### Documentation Standards

- Keep README.md user-focused (setup, usage, troubleshooting)
- Keep CLAUDE.md developer-focused (architecture, patterns, workflows)
- Use `docs/` folder for detailed feature documentation and implementation notes
- Include examples and command snippets where helpful
- Update the "Project Structure" tree in README.md if directory structure changes

## Testing Workflow

1. Start dev server: `npm run dev`
2. Configure `.env.local` with test credentials
3. Test API endpoints through UI at `http://localhost:3000`
4. Check proxy logs in terminal for debugging (correlation IDs, mTLS status)
5. Common errors:
   - 401: Check `acquiring_partner_api_key` format and validity
   - 403: mTLS certificate issues or IP restrictions
   - Certificate errors: Verify cert/key files in `certs/` directory

## Technology Stack

- **Framework:** Next.js 14 (App Router)
- **UI:** React 18, Material-UI (MUI), Tailwind CSS
- **HTTP Client:** Native Node.js `https` module (for mTLS)
- **Visualization:** ReactFlow (network diagrams), dagre (graph layout)
- **JSON Handling:** @uiw/react-json-view
- **TypeScript:** Strict mode enabled

## Key Files Reference

- `app/api/klarna-proxy/route.ts:67-82` - mTLS certificate loading
- `app/api/klarna-proxy/route.ts:84-130` - Klarna header generation
- `app/api/klarna-proxy/route.ts:133-218` - HTTPS request with mTLS
- `lib/klarna-endpoints.ts:38-1316` - All endpoint preset definitions
- `lib/types.ts:1-336` - Complete TypeScript type system
